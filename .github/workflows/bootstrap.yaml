name: ACM and GitOps
on:
  workflow_dispatch:

jobs:
  Setup:
    name: ACM and GitOps
    runs-on: ubuntu-latest
    steps:      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
        
      - name: Install OpenShift CLI tools
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          openshift-install: "${{secrets.OCP_CLIENT_VERSION}}"
          oc: "${{secrets.OCP_CLIENT_VERSION}}"
          
      - name: Download Artifacts from Cluster Deploy
        uses: dawidd6/action-download-artifact@v4
        with:
          workflow: deploy.yaml
          name: ocp-artifact
          path: ocp-artifact

      - name: Rollout ACM/GitOps Operators  
        uses: actions/checkout@main
        run: |
          cp ocp-artifact/auth/kubeconfig $GITHUB_WORKSPACE/kubeconfig
          export KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig

          oc apply -k gitops || true  # Apply Operators but don't fail immediately
          echo "Waiting for Operators to be ready..."
          sleep 60  # Initial delay before checking status

          # Wait for all operators to be available
          for i in {1..10}; do
            NOT_READY=$(oc get csv -n openshift-operators --no-headers | grep -v "Succeeded" || true)
            if [[ -z "$NOT_READY" ]]; then
              echo "All Operators are ready."
              break
            fi
            echo "Operators are still installing..."
            sleep 30
          done

      - name: Re-Run to deploy Operands
        run: |
          oc apply -k gitops  # Apply kustomize manifests